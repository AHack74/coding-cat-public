#!/bin/bash

set -e

OUTFILE="problems.js"
TMPFILE="$(mktemp).js"
echo "Building problem list in $TMPFILE ... "

write() {
    echo "$@" >> "$TMPFILE"
}

load-problem-name() {
    jq -r .meta.name "$1/problem.json"
}

is-problem-enabled() {
    if [ -f enabled-problems ] ; then
        grep -q "$1" enabled-problems
    else
        return 0 # all problems are enabled if there's no list
    fi
}

write "// THIS FILE IS AUTOGENERATED. DO NOT EDIT MANUALLY."
write ""

for f in * ; do
    [ ! -d "$f" ] && continue

    name="$(load-problem-name "$f")"
    is-problem-enabled "$name" && write "import" "$name" "from './$f/problem.json';"
done

write "const problems = ["
for f in * ; do
    [ ! -d "$f" ] && continue

    name="$(load-problem-name "$f")"
    is-problem-enabled "$name" && write "    $name,"
done
write "];"

write "export default problems;"

echo "Build succeeded. Overwriting $OUTFILE"
mv "$TMPFILE" "$OUTFILE"
